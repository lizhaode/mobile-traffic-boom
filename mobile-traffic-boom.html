<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
    <title>流量消失器</title>
  </head>
  <body>
    <div class="card" style="width: 50%; margin: 0 auto">
      <div class="card-header" style="text-align: center">
        <h2>流量消失神器</h2>
        <h6 class="card-subtitle mb-2 text-muted" style="text-align: center">多线程消耗流量 运营商直呼内行</h6>
      </div>
      <div class="card-body">
        <p class="card-text" style="text-align: center">Chrome 在同一域名下默认最多6个并发请求</p>
        <table class="table table-borderless">
          <tbody>
            <tr>
              <td>地址</td>
              <td>
                <input
                  name="d-url"
                  type="url"
                  class="form-control"
                  id="d-url"
                  placeholder="https://ossweb-img.qq.com/upload/adw/image/752/20211219/f4b5919ec683f49d8532cef90644b9ac.jpeg"
                  aria-label="https://ossweb-img.qq.com/upload/adw/image/752/20211219/f4b5919ec683f49d8532cef90644b9ac.jpeg"
                  value="https://ossweb-img.qq.com/upload/adw/image/752/20211219/f4b5919ec683f49d8532cef90644b9ac.jpeg"
                />
              </td>
            </tr>
          </tbody>
          <tbody>
            <tr>
              <td>请求次数</td>
              <td>
                <input
                  name="d-cycles"
                  type="number"
                  id="d-cycles"
                  class="form-control"
                  placeholder="0 表示永不停止"
                  aria-label="0 表示永不停止"
                  value="0"
                />
              </td>
            </tr>
          </tbody>
          <tbody>
            <tr>
              <td>并发数</td>
              <td>
                <input
                  name="d-parallel"
                  type="number"
                  id="d-parallel"
                  class="form-control"
                  placeholder="6"
                  aria-label="6"
                  value="6"
                />
              </td>
            </tr>
          </tbody>
          <tbody>
            <tr>
              <td>
                <input type="button" class="btn btn-primary btn-lg" id="start" onclick="startClick()" value="开始" />
              </td>
              <td>
                <p class="placeholder-glow">
                  总共消耗流量: <span class="placeholder col-8 placeholder-lg" id="downloaded"></span>
                </p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <script type="text/javascript">
      async function startClick() {
        let downloadLength = 0;
        let url = document.getElementById('d-url').value;
        let cycles = document.getElementById('d-cycles').valueAsNumber;
        let parallel = document.getElementById('d-parallel').valueAsNumber;
        let downloadedElement = document.getElementById('downloaded');
        downloadedElement.classList.remove('placeholder', 'col-8', 'placeholder-lg');
        if (cycles === 0) {
          while (1) {
            downloadLength += await parallelDownload(url, parallel);
            downloadedElement.textContent = getFileSize(downloadLength);
          }
        } else {
          for (let i of Array(cycles)) {
            downloadLength += await parallelDownload(url, parallel);
            downloadedElement.textContent = getFileSize(downloadLength);
          }
        }
      }

      async function parallelDownload(url, parallel) {
        let length = 0;
        const responseAll = await Promise.allSettled(
          Array(parallel)
            .fill(url)
            .map((url) => {
              return download(url);
            })
        );
        for (let response of responseAll) {
          if (response.status === 'fulfilled') {
            length += response.value;
          }
        }
        return length;
      }

      async function download(url) {
        let holeLength = 0;
        let response = await fetch(url);
        const reader = response.body.getReader();
        while (1) {
          const { done, value } = await reader.read();
          if (done) break;
          holeLength += value.byteLength;
        }
        return holeLength;
      }

      function getFileSize(size) {
        if (!size) return '';
        const num = 1024.0;
        if (size < num) return size + 'B';
        if (size < Math.pow(num, 2)) return (size / num).toFixed(2) + 'KB';
        if (size < Math.pow(num, 3)) return (size / Math.pow(num, 2)).toFixed(2) + 'MB';
        if (size < Math.pow(num, 4)) return (size / Math.pow(num, 3)).toFixed(2) + 'G';
        return (size / Math.pow(num, 4)).toFixed(2) + 'T';
      }
    </script>
  </body>
</html>
